<!DOCTYPE html>
<html lang="en-US">
<head>
<!-- Advanced Search Form for a Responsive ContentDM Site -->
<!-- Derived from Ohio Memory Advanced Search Form, https://ohiomemory.org//customizations/global/pages/advancedsearch_resources/advanced_search.html -->
<!-- version: 2020.0306-1012 -->

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Advanced Search</title>
<base href="//digital.archives.alabama.gov/customizations/global/pages/assets/html/advanced-search-form.html" />
<link href="/customizations/global/pages/assets/css/advanced-search-form.css" media="all" rel="stylesheet" />

<script src="/customizations/global/pages/assets/js/jquery-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.13.2/tingle.js"></script>

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css?ver=4.9.8" id="bootstrap-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/css/bootstrap-select.min.css?ver=4.9.8" id="bootstrap-select-css-css" media="all" rel="stylesheet" type="text/css"/>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js?ver=4.9.8" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/js/bootstrap-select.min.js?ver=4.9.8" type="text/javascript"></script>

<script type="text/javascript">
// from: https://stackoverflow.com/questions/6644654/parse-an-url-in-javascript
/**
 * @param string url
 * @return object
 */
function parseUrl ( url ) {
	let a = document.createElement('a');
	a.href = url;
	return a;
} /* parseUrl() */

function cdmOriginUrl () {
	let base = jQuery('base');
	let url = (base.length > 0 ? base.attr('href') : window.location.href);
	return parseUrl(url).origin;
}

// 
jQuery(document).ready(function($){

    function isValidDate(dateString) {
        var regEx1 = /^\d{4}-\d{2}-\d{2}$/;
        var regEx2 = /^\d{4}-\d{2}$/;
        var regEx3 = /^\d{4}$/;
        if ( !dateString.match(regEx1) && !dateString.match(regEx2) && !dateString.match(regEx3) ) {
            return false;  // Invalid format
        } else {
            return true;
        }
    }
    
    $( "#advSearchForm" ).submit(function(e) {

        e.preventDefault();
		
        var searchurl = cdmOriginUrl() + '/digital/search';
        var modevalues = [];
        var modeClasses = [];
        var searchCriteria = "";
        var searchtermvalues = [];
        var connvalues = [];
        var fieldvalues = [];
        var crossCollectionSearch = $("#selectCollections").val() === null || $("#selectCollections").val().length > 1;



        // search terms
        var searchterms = $( "input[name='searchterm']" ).serializeArray();

        $.each( searchterms, function( i, searchterm ) {
            if ( modeClasses[i] != 'near' && searchterms[i].value != "" ) {
                searchtermvalues.push(searchterm.value);
            } else {
                var searchText = searchterm.value;
                searchText = searchText.replace(/  +/g, ' ');
                searchText = searchText.trim(searchText);
                var searchTermsArray = searchText.split(" ");
                searchtermvalues.push(searchTermsArray.join(' near5 '));
            }
        });

        // modes
        var modes = $( "select[name='mode'] option:selected");
        $.each( modes, function( i, mode ) {
            modeClasses.push(mode.getAttribute('class'));
            if (searchterms[i].value != "") {
                modevalues.push(mode.value);
            }
        });

        // fields
        var fields = $( "select[name='field']" ).serializeArray();
        $.each( fields, function( i, field ) {
            
            /*if (field.value == 'coverab') { 
                if (!crossCollectionSearch) {
                    field.value = 'time';
                }
            }*/
            if (searchterms[i].value != "") {
                fieldvalues.push(field.value);
            }
        });
        sessionStorage.setItem('fieldvalues', fieldvalues.join("!"));

        // collections
        var collCriteria = ""; 
        if ($("#selectCollections").val() !== null) {
            var searchCollectionValues = $("#selectCollections").val();
            if (searchCollectionValues.length > 0 && searchCollectionValues.length < 147) {
                $('#restrict_options').text(searchCollectionValues.length + " collections chosen");
                collCriteria = '/collection/' + searchCollectionValues.join("!");
            }
        }
        /*else {
            $('#restrict_options').text("All formats");
            collCriteria = 'collection/all';
        }*/ 
        
        // connectors
        var conns = $( "select[name='conn']" ).serializeArray();
        $.each( conns, function( i, conn ) {
            if (searchterms[i].value != "") {
                connvalues.push(conn.value);
            }
        });
        
        // formats (from drop-down)
        if ( Array.isArray($("#selectFormats").val()) && $("#selectFormats").val().length > 0 ) {
            searchtermvalues.push($("#selectFormats").val().join(" "));
            fieldvalues.push("format");
            modevalues.push("any");
            connvalues.push("and");
        } 

        // dates (from input)
        if ( isValidDate($("#firstDateField").val()) && isValidDate($("#secondDateField").val()) ) {
            searchtermvalues.push($("#firstDateField").val().replace(/-/g, '') + "-" + $("#secondDateField").val().replace(/-/g, ''));
            //if (searchCollectionValues.length > 1) { fieldvalues.push("date"); } else { fieldvalues.push("search"); }
            if ($("#selectCollections").val() === null) { fieldvalues.push("date"); } else { fieldvalues.push("search"); }
            modevalues.push("exact");
            connvalues.push("and");
        } 

        if (searchtermvalues.length > 0) {
            var searchvals = searchtermvalues.join("!");
            if ( searchvals.startsWith("!") ) {
                searchvals = searchvals.substr(1);
            }
            searchCriteria = 'searchterm/' + searchvals;
        }
        // https://ohiomemory.org/customizations/global/pages/advancedsearch_resources/advanced_search.html?undefined&search/searchterm/buckeye%20steamboat/field/all/mode/all/conn/and
        // e.g https://ohiomemory.org/digital/search/collection/p267401coll32!p16007coll51/searchterm/war!battle!19050101-19191231/field/subjec!all!date/mode/all!all!exact/conn/and!and!and/order/nosort 1905-01-01 1919-12-31
        searchurl += collCriteria + '/' + searchCriteria + '/field/' + fieldvalues.join("!") + '/mode/' + modevalues.join("!") + '/conn/' + connvalues.join("!");

        //if (collCriteria.match('p16007coll22')) {

            window.parent.location.href = searchurl;
        //}

    });


    $( "#addfield" ).click(function(e) {
        e.preventDefault();
        addLine();
    });

    $('.close').click(function() {
        $(this).parent().parent().parent().remove();
    });

    function makeIsoDate(d) {
        var dd = "";
        d.substring(0, 4) !== "" ? dd += d.substring(0, 4) : "";
        d.substring(4, 6) !== "" ? dd += "-" + d.substring(4, 6) : "";
        d.substring(6, 8) !== "" ? dd += "-" + d.substring(6, 8) : "";
        return dd;
    }

    // autofill search form using values from from URL
    // e.g. /customizations/global/pages/advancedsearch_resources/advanced_search.html?p267401coll34!p267401coll32&search/collection/p267401coll34!p267401coll32/searchterm/war!1860-1863/field/subjec!date/mode/all!all/conn/and!and
    
    //console.log(window.location.search);
    //console.log(window.location.search.substring(1).split('&search'));
    //if (window.location.search.substring(1) !== 'undefined&' && window.location.search.substring(1) != "") {

    if (sessionStorage.getItem('lastSearchUrl') !== null) {
        var ssUrl = sessionStorage.getItem('lastSearchUrl');

        // if coveraa, change to place
        //ssUrl = ssUrl.replace(/coveraa/, 'Place');
        //console.log('ssUrl: ' + ssUrl);
        if (ssUrl.match(/\/collection\//) != null) {
            var collectionString = ssUrl.replace(/^.*?\/collection\/(.*?)\/.*/, '$1');
            //var lastCollectionSelected = lastCriteriaSelected[0].split("!");
            var lastCollectionSelected = collectionString.split("!");
            //$('.selectpicker').selectpicker('val', lastCollectionSelected);
            
            $.getJSON( cdmOriginUrl() + "/digital/bl/dmwebservices/index.php?q=dmGetCollectionList/json", function( data ) {
                var items = [];
                $.each( data, function( i, prop ) {
                    items.push( '<option id="' + prop.alias.substring(1) + '" value="' + prop.alias.substring(1) + '">' + prop.name + '</option>' );
                });
                $("#selectCollections").html(items.join(""));

                // initialize collections drop-down
                $('.collectionselectpicker').selectpicker({
                    actionsBox: true,
                    style: 'btn-info',
                    virtualScroll: true
                });
                $('.collectionselectpicker').selectpicker('val', lastCollectionSelected);
            });

            
        }
        //console.log(sessionStorage);
        //console.log(lastCriteriaSelected[1]);
        // replaced lastCriteriaSelected[1] with ssURL
        //if ( ssURL.includes('searchterm') ) {

            // search terms
            //var termString = ssURL.replace(/^.*?searchterm\/(.*?)(\/.*|$)/, '$1');
            var termString = ssUrl.replace(/^.*?searchterm\/(.*?)(\/.*|$)/, '$1');
            var terms = termString.split("!");
            var formatValues = ["picture", "objects", "books", "manuscripts", "newspapers", "government", "sound", "video"];

            // fields
            var fieldString = ssUrl.replace(/^.*?\/field\/(.*?)\/.*/, '$1');
            var fields = fieldString.split("!");

            // mode
            var modeString = ssUrl.replace(/^.*?\/mode\/(.*?)\/.*/, '$1');
            var modes = modeString.split("!");

            // connector
            var connString = ssUrl.replace(/^.*?\/conn\/(.*?)(\/|$)/, '$1');
            var conns = connString.split("!");

            // dates
            var dates = [];
            if (fields[0] == "date" || fields[0] == "search") {
                dates = terms[0].split("-");
                $('#firstDateField').val(makeIsoDate(dates[0]));
                $('#secondDateField').val(makeIsoDate(dates[1]));
            }
            
            if (fields[0] == "Place" || fields[0] == "coveraa") {
                fields[0] = "coveraa";
                //$('#mode option[class="coveraa"]').attr('selected', 'selected');
            }
            //$('.fieldselectpicker').selectpicker('val', fields[0]);
            /*if (fields[0] == "time" || fields[0] == "coverab") {
                fields[0] = "coverab";
            }*/

            if (modes[0].length < 3 || modes[0].length > 5) { modes[0] = "all"; }
            if (fields[0].length < 4 || fields[0].length > 7) { fields[0] = "all"; }
            if (conns[0].length < 2 || conns[0].length > 3) { conns[0] = "and"; }
            if (fields[0] == "format" && formatValues.indexOf(decodeURI(terms[0]).split(" ")[0]) > -1) {
                var lastFormatsSelected = decodeURI(terms[0]).split(" ");
                $('.formatselectpicker').selectpicker();
                $('.formatselectpicker').selectpicker('val', lastFormatsSelected);
            } else {
                $("select[name='field']").val(fields[0]);
            }
            if ( decodeURI(terms[0]).match(/near5/) ) {
                var unencodedTermsString = decodeURI(terms[0]).replace(/' '/g, '');
                var termsArray = unencodedTermsString.split('near5');
                terms[0] = termsArray.join(" ");
                //console.log($('#mode option[class="near"]'));
                $('#mode option[class="near"]').attr('selected', 'selected');
            } else {
                $("select[name='mode']").val(modes[0]);
            }
            if (!decodeURI(terms[0]).match( /(\d\d\d\d.*\d\d|\d\d\d\d)/mg ) ) {
                $("input[name='searchterm']").val( decodeURI(terms[0]) );
            } 
            
            $("select[name='conn']").val(conns[0]);

            // need to addline() for each term after first
            if (terms.length > 1) {
                for (i = 1; i < terms.length; i++) {
                    if (modes[i].length < 3 || modes[i].length > 5) { modes[i] = "all"; }
                    if (fields[i].length < 4 || fields[i].length > 7) { fields[i] = "all"; }
                    if (conns[i].length < 2 || conns[i].length > 3) { conns[i] = "and"; }
                    if (fields[i] == "date" || fields[i] == "search") {
                        dates = terms[i].split("-");
                        $('#firstDateField').val(makeIsoDate(dates[0]));
                        $('#secondDateField').val(makeIsoDate(dates[1]));
                        continue;
                    }
                    if (fields[i] == "Place" || fields[i] == "coveraa") {
                        fields[i] = "coveraa";
                    }
                    //$('.fieldselectpicker').selectpicker('val', fields[0]);
                    if (fields[i] == "format" && formatValues.indexOf(decodeURI(terms[i]).split(" ")[0]) > -1) {
                        var lastFormatsSelected = decodeURI(terms[i]).split(" ");
                        $('.formatselectpicker').selectpicker();
                        $('.formatselectpicker').selectpicker('val', lastFormatsSelected);
                        continue;
                    } 
                    //$("select[name='field']").val(fields[i]);
                    //$("select[name='field']")[i].value = fields[i];
                    /*console.log(i);
                    console.log(document.querySelectorAll('#field')[i]);
                    console.log(fields[i]);
                    document.querySelectorAll('#field')[i] = fields[i];
*/
                    /*else {
                        $("select[name='field']").val(fields[i]);
                        continue;   
                    }*/
                    addLine(terms[i], modes[i], fields[i], conns[i]); 
                }
            }
        //}
    }

    function addLine(sterm, mode, field, conn) {
        
        (typeof sterm == "undefined" || sterm == "") ? sterm = "" : sterm = sterm;
        (typeof mode == "undefined" || mode == "") ? mode = "all" : mode = mode;
        (typeof field == "undefined" || field == "") ? field = "all" : field = field;
        (typeof conn == "undefined" || conn == "") ? conn = "and" : conn = conn;
        
        var newLine = $(".adv_search_row:last").clone(true, true);
        $( "#adv_search_query_builder_list" ).append( newLine );
        var newInput = newLine.find("input");
        var newSelects = newLine.find("select");
        
        if ( decodeURI(sterm).match(/near5/) ) {
            var unencodedTermsString = decodeURI(sterm).replace(/' '/g, '');
            var termsArray = unencodedTermsString.split('near5');
            sterm = termsArray.join(" ");
            $(newSelects[0]).children().last().attr('selected', 'selected');
        }  else {
            $(newSelects[0]).val(mode);
        }
        
        newInput.val(sterm);
        $(newSelects[1]).val(field);
        $(newSelects[2]).val(conn);
    }

});

</script>
</head>

<body class="page-template page-template-template-full-width page-template-template-full-width-php page page-id-2703">
    <br/>
    <form class="form-inline" id="advSearchForm" name="searchForm">
        <div id="advanced-search-box" style="text-align: center;">
            <div class="form-group" id="advanced-search">      
                <div class="AdvancedSearch-sectionWrapper">
                    <div class="col-md-8 col-md-offset-2 AdvancedSearch-content">
                        <div class="well well-sm DateSearch-container">
                            <ul id="adv_search_query_builder_list">
                                <li class="adv_search_row">
                                    <ul class="adv_search_ul_row">
                                        <li class="criteria">
                                            <select id="mode" class="form-control" name="mode">
                                                <option class="all" selected="selected" value="all">
                                                    All of the words
                                                </option>
                                                <option class="any" value="any">
                                                    Any of the words
                                                </option>
                                                <option class="exact" value="exact">
                                                    The exact phrase
                                                </option>
                                                <option class="none" value="none">
                                                    None of the words
                                                </option>
                                                <option class="near" value="exact">
                                                    Within 5 words
                                                </option>
                                            </select>
                                        </li>
                                        <li class="criteria spaceMar5L spacePad5">
                                            <input class="form-control" name="searchterm" type="text"/>
                                        </li>
                                        <span>&nbsp;in&nbsp;</span>
                                        <li class="criteria spaceMar5L">
                                                <select id="field" class="form-control" name="field">
                                                    <option class="all" selected="selected" value="all">
                                                        All fields
                                                    </option>
                                                    <option class="title" value="title">
                                                        Title
                                                    </option>
                                                    <option class="creato" value="creato">
                                                        Creator
                                                    </option>
                                                    <option class="subjec" value="subjec">
                                                        Subject
                                                    </option>
                                                    <option class="coveraa" value="coveraa">
                                                        Place
                                                    </option>
                                                    <option class="descri" value="descri">
                                                        Description
                                                    </option>
                                                    <option class="contri" value="relatig">
                                                        Collection
                                                    </option>
                                                    <option class="contri" value="contri">
                                                        Contributor
                                                    </option>
                                                    <option class="date" value="date">
                                                        Date of Original
                                                    </option>
                                                    <option class="format" value="format">
                                                        Format
                                                    </option>
                                                    <option class="identi" value="identi">
                                                        Identifier
                                                    </option>
                                                    <option class="source" value="source">
                                                        Source
                                                    </option>
                                                    <option class="extent" value="extent">
                                                        Extent
                                                    </option>
                                                </select>
                                            
                                        </li>
                                        <li class="criteria spaceMar5L">
                                            <select class="form-control" name="conn">
                                                <option selected="selected" value="and">
                                                    and
                                                </option>
                                                <option value="or">
                                                    or
                                                </option>
                                            </select>
                                        </li>
                                        <li class="adv_search_option_remove_link_box criteria spacePad5 spaceMarTop5">&nbsp;&nbsp;
                                            <button class="close" type="button">
                                                ×
                                            </button>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                            <br/>
                            <a alt="" href="" id="addfield">
                                Add another line
                            </a>
                        </div>
                    </div>
                </div>

                <div class="AdvancedSearch-sectionWrapper" style="text-align:left">
                    <div class="col-md-8 col-md-offset-2 AdvancedSearch-content">
                        <div class="well well-sm">
                            <div id="restrict_element" class="form-group checkbox-inline">
                                Restrict Search to: &nbsp;&nbsp;
                                <select id="selectFormats" class="form-group formatselectpicker" title="Select Formats" multiple data-selected-text-format="count">
                                    <option value="picture"> Images (photographs, paintings, etc.)</option>
                                    <option value="objects"> Objects (archaeological, historical, natural history)</option>
                                    <option value="books"> Books</option>
                                    <option value="manuscripts"> Manuscripts (letters, diaries, etc.)</option>
                                    <option value="newspapers"> Newspapers</option>
                                    <option value="government"> State agency publications</option>
                                    <option value="sound"> Sound</option>
                                    <option value="video"> Video</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="AdvancedSearch-sectionWrapper">
                    <div class="col-md-8 col-md-offset-2 AdvancedSearch-content">
                        <div class="well well-sm DateSearch-container">
                            <div class="DateSearch-flexContainer">
                                <div class="DateSearch-input">
                                    <label>
                                        <span>Dates between</span>
                                        <input type="text" aria-label="Enter Date" class="form-control" value="" id="firstDateField">
                                    </label>
                                </div>
                                <div class="DateSearch-input">
                                    <label>
                                        <span>and</span>
                                        <input type="text" aria-label="Enter Date 2" class="form-control" value="" id="secondDateField">
                                    </label>
                                </div>
                            </div>
                            <div class="DateSearch-footer">
                                <div></div>
                            <div>
                                <span>e.g. yyyy, yyyy-mm, yyyy-mm-dd</span>
                            </div>
                            <div></div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div></div>
                <div class="AdvancedSearch-sectionWrapper" style="text-align:left">
                    <div class="col-md-8 col-md-offset-2 AdvancedSearch-content">
                        <div class="well well-sm">
                            <div id="restrict_element" class="form-group checkbox-inline">
                                <select id="selectCollections" class="form-group collectionselectpicker" title="Select Collections" multiple data-selected-text-format="count"></select>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  
                                <!--<span id="sourcesHelp" class="linkClass" title="Clicking the checkbox will exclude resources containing full text, such as newspapers or books.">Exclude full text sources</span>? 
                                <input type="checkbox" name="fulltext" id="ft-yes">-->
                                <!--<input type="checkbox" name="fulltext" id="ft-yes" style=""> <a href="#" onclick="alert('hi');return false;">Exclude full text sources?</a>-->  
                            </div>
                        </div>
                    </div>
                </div>

                <div style="clear:both;margin-top:10px"></div>
                <div class="submit">
                    <button id="submit_search" class="btn btn-primary" type="submit">Submit</button> 
                </div>

            </div>
        </div>
    </form>
</body>
</html>

<script>
/*
 * derived from comments in: https://ohiomemory.org//customizations/global/pages/advancedsearch_resources/advanced_search.html
 *
 * API:
 * $.getJSON( "{cdmOriginUrl}/digital/bl/dmwebservices/index.php?q=dmGetCollectionList/json", function( data ) { ... } );
 * filters "data for collection options"
 *
 * Format:
 *
 * data = [
 *  {
 *     "alias":"\/p16007coll29",
 *     "name":"1840s Campaign Newspapers",
 *     "path":"\/cdm\/sites\/16007\/data\/p16007coll29",
 *     "secondary_alias":"2"
 *  },
 *  {
 *     "alias":"\/p15005coll3",
 *     "name":"Adena Collection",
 *     "path":"\/cdm\/sites\/16007\/data\/p15005coll3",
 *     "secondary_alias":"p15005coll3"
 *  },
 *  // ...
 * ]
 */

// create collection options
$.getJSON( cdmOriginUrl() + "/digital/bl/dmwebservices/index.php?q=dmGetCollectionList/json", function( data ) {
    var items = [];
    $.each( data, function( i, prop ) {
        items.push( '<option id="' + prop.alias.substring(1) + '" value="' + prop.alias.substring(1) + '">' + prop.name + '</option>' );
    });
    $("#selectCollections").html(items.join(""));

    // initialize collections drop-down
    $('.collectionselectpicker').selectpicker({
        actionsBox: true,
        style: 'btn-info',
        virtualScroll: true
    });
});



// initialize format drop-down
$('.formatselectpicker').selectpicker({
    style: 'btn-info',
    width: '18em',
    size: 8
});

//$('.fieldselectpicker').selectpicker();

</script>
